---
import { Button } from "@/components/ui/button";
import { Image } from "astro:assets";
import HeaderLink from "./HeaderLink.astro";
import Cardinal from "../assets/cardinal.svg";
import { menuLinks } from "../consts/menuLinks.ts";
import type { MenuLink } from "../types/MenuLink.types";
---

<div class="flex flex-col w-full">
  <header
    id="floating-header"
    class="fixed top-2 left-1/2 -translate-x-1/2 z-50 flex flex-row items-center justify-between px-2 sm:px-4 py-1 rounded-xs shadow-lg bg-secondary/90 backdrop-blur-md border border-secondary/30 md:w-[98vw] w-[95vw] transition-all duration-300 md:max-w-7xl"
  >
    <a href="/" class="flex pl-2 items-center">
      <Image
        class="w-8 h-8 sm:w-12 sm:h-12 mr-2 sm:mr-4"
        src={Cardinal}
        alt="Icon"
        loading="eager"
      />
    </a>

    <nav class="hidden lg:flex items-center space-x-6">
      <ul class="flex items-center space-x-6 text-foreground">
        {
          menuLinks.map((link: MenuLink) => (
            <HeaderLink href={link.href}>{link.text}</HeaderLink>
          ))
        }
        <li>
          <Button variant="highlight">
            <a href="/contact">Contact me</a>
          </Button>
        </li>
      </ul>
    </nav>
    <button data-mobile-menu-btn class="lg:hidden pr-2 block"
      ><svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
        class="w-6 h-6 cursor-pointer md:hidden block"
        id="lines"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M3.75 9h16.5m-16.5 6.75h16.5"></path>
      </svg>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
        class="w-6 h-6 cursor-pointer md:hidden hidden"
        id="close"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
  </header>
  <nav
    id="mobile-nav"
    class="bg-white/10 backdrop-blur-xl backdrop-saturate-150 border border-white/20 text-foreground p-2 z-40 fixed top-16 left-1/2 -translate-x-1/2 w-[90vw] max-w-sm rounded-2xl shadow-lg hidden transition-all duration-300"
  >
    <ul class="flex flex-col space-y-4 text-foreground">
      {
        menuLinks.map((link: MenuLink) => (
          <li class="w-full pb-2 border-b border-primary transition-all duration-300">
            <a href={link.href} class="hover:text-secondary-foreground block">
              {link.text}
            </a>
          </li>
        ))
      }
      <li class="w-full">
        <Button variant="highlight">
          <a href="/contact">Contact me</a>
        </Button>
      </li>
    </ul>
  </nav>
</div>
<script>
  function showMenu() {
    const menu = document.getElementById("mobile-nav");
    menu?.classList.toggle("hidden");
    menu?.classList.toggle("flex");
    menu?.classList.toggle("flex-col");

    const hamburger = document.getElementById("lines");
    const close = document.getElementById("close");
    hamburger?.classList.toggle("hidden");
    close?.classList.toggle("hidden");
  }

  function initScrollBehavior() {
    let lastScrollY = window.scrollY;
    let isScrollingDown = false;
    let scrollTimeout: ReturnType<typeof setTimeout>;

    const header = document.getElementById("floating-header");
    if (!header) return;

    function handleScroll() {
      if (!header) return;

      const currentScrollY = window.scrollY;
      const scrollDifference = Math.abs(currentScrollY - lastScrollY);

      // Only react to meaningful scroll movements
      if (scrollDifference < 5) return;

      // Determine scroll direction
      if (currentScrollY > lastScrollY && currentScrollY > 100) {
        // Scrolling down and past initial threshold
        if (!isScrollingDown) {
          isScrollingDown = true;
          header.style.transform = "translateY(-120%)";
          header.style.opacity = "0";
        }
      } else if (currentScrollY < lastScrollY) {
        // Scrolling up
        if (isScrollingDown) {
          isScrollingDown = false;
          header.style.transform = "translateY(0%)";
          header.style.opacity = "1";
        }
      }

      // Always show header when at top of page
      if (currentScrollY <= 50) {
        isScrollingDown = false;
        header.style.transform = "translateY(0%)";
        header.style.opacity = "1";
      }

      lastScrollY = currentScrollY;

      // Clear existing timeout
      clearTimeout(scrollTimeout);

      // Show header briefly after scroll stops
      scrollTimeout = setTimeout(() => {
        if (header && (!isScrollingDown || currentScrollY <= 50)) {
          header.style.transform = "translateY(0%)";
          header.style.opacity = "1";
        }
      }, 150);
    }

    // Throttled scroll handler
    let ticking = false;
    function requestScrollUpdate() {
      if (!ticking) {
        requestAnimationFrame(() => {
          handleScroll();
          ticking = false;
        });
        ticking = true;
      }
    }

    window.addEventListener("scroll", requestScrollUpdate, { passive: true });
  }

  function addListeners() {
    const menus = document.querySelectorAll("[data-mobile-menu-btn]");
    menus.forEach((menu) =>
      menu.addEventListener("click", () => {
        showMenu();
      }),
    );

    // Initialize scroll behavior
    initScrollBehavior();
  }

  document.addEventListener("astro:after-swap", addListeners);
  addListeners();
</script>
