---
import { getCollection } from "astro:content";
import BlogPost from "../../layouts/BlogPost.astro";
import type { BlogPost as BlogPostType } from "../../content/config";

import { SITE_DESCRIPTION } from "../../consts";
import BaseLayout from "../../layouts/BaseLayout.astro";

const posts = await getCollection("blog");
let postPage: BlogPostType | undefined = undefined;
posts.map((post: BlogPostType) => {
  if (Astro.params.slug === post.slug) {
    if (post.data.draft && process.env.NODE_ENV !== "development")
      Astro.redirect("/blog");
    postPage = post;
  }
});

if (!postPage) {
  Astro.redirect("/blog");
}

// TypeScript knows postPage is defined here due to the redirect above
const { Content } = await postPage!.render();
const title = `${postPage!.data.title} | JH`;
---

<BaseLayout title={title} description={postPage!.data.description || SITE_DESCRIPTION} image={postPage!.data.heroImage}>
  <BlogPost {...postPage!.data}>
    <Content />
  </BlogPost>
</BaseLayout>
